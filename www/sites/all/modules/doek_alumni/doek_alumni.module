<?php

//Insert Unique ID for a new user
function doek_alumni_user_insert(&$edit, $account, $category){
        $query = db_query("SELECT max(field_alumnimedlem_value) max FROM field_data_field_alumnimedlem");

        $result = $query->fetchObject();

        $member_id = $result->max;
	$edit['field_alumnimedlem']['und'][0]['value'] = $member_id + 1;		
}

function doek_payment_import_users_from_file(){
        $count = 0;

        $dest = variable_get('file_public_path', conf_path() . '/files');

        $file = fopen($dest."/alumni.csv", "r");

        $protected = array("uid", "navn");
        $matching = array("alumni" => "field_alumnimedlem", "date" => "field_payment_", "status" => "field_payment_status");

        $headers = fgetcsv($file);

        while($line = fgetcsv($file)){
		$uid = $line[0];
		$query = db_query("SELECT entity_id id FROM field_data_field_alumnimedlem WHERE field_alumnimedlem_value = $uid");
	        $result = $query->fetchObject();
        	$user_id = $result->id;

	        if($user = user_load($user_id)){
		
			$index = 0;
			foreach($line as $field){

				$line_header = (in_array($headers[$index], array_keys($matching))) ? $matching[$headers[$index]] : $headers[$index];
				//echo $line_header." : ".$field."<br />";
				if(!in_array($line_header, $protected)){
					//echo $line_header." : ".$field."<br />";
					$edit['roles'] = array(12 =>'Alumni_aktiv');
					$edit[$line_header]['und'][0]['value'] = $field;
				}
				$index++;
			}
			user_save($user, $edit);
			$count++;
		}
        }
        fclose($file);
	return true;
}

/*
function doek_alumni_form_alter(&$form, &$form_state, $form_id){

	if(!($form_id == 'user_register_form' || $form_id == 'user_profile_form')){
		return;
	}
	global $user;

	if(is_array($user->roles) && in_array('administrator', $user->roles)){

		$form['alumni'] = array(
				'#type' 	=> 'fieldset', 
				'#title' 	=> t('DÃ˜K Alumni Oplysninger'),
				'#collapsible'	=> TRUE, 
				'#collapsed'	=> FALSE,
				'#weight'	=> 10,
				);

		$form['alumni']['membership'] = array(
				'#type'		=> 'checkbox',
				'#options'	=> array('aktiv' => 1, 'inaktiv' => 2),
				'#title'	=> t('Alumni medlem'),
				'#description'	=> t('Om personen er medlem af Alumni'),
				);

		$form['alumni']['payment_date'] = array(
				'#type'		=> 'date',
				'#title'	=> t('Betalingsdag'),
				'#description'	=> t('Data hvor personen har betalt for medlemsskab'),
				);
		
		$form['alumni']['member_id'] = array(
				'#type'		=> 'textfield',
				'#title'	=> t('Medlemsnummer'),
				'#description'	=> t('Brugerens medlemsnummer fra den gamle database'),
				'#maxlength'	=> 30,
				'#size'		=> 30,
				);

	}
		return $form;
}
*/


function assign_membership_number(){

	$query = db_query("SELECT max(field_alumnimedlem_value) max FROM field_data_field_alumnimedlem");
	
	$result = $query->fetchObject();

	$current_number = $result->max;
	$counter = 0;

	$role_users = db_query("SELECT uid FROM users WHERE uid != 0");

	foreach($role_users as $account){
		$account = user_load($account->uid);
			//die(var_dump($account));	

		if(empty($account->field_alumnimedlem)){
			$edit = array(
				'field_alumnimedlem' => array(
					'und' => array(
						'0' => array(
							'value' => $current_number + 1,
							),
						),
					),
				);
		        $current_number++;	
			user_save($account, $edit);
			$counter++;
		}
	}

	return true;
}


function doek_alumni_cron(){

	$status = false;

	//$status = assign_membership_number();

	$status = doek_payment_import_users_from_file();	
	
	return $status;
}

